##  链路层

### 可靠传输



#### 滑动窗口

##### ==特性==

1. 只有接受窗口向前滑动（同时接收方发送了确认帧）时，发送窗口才有可能（只有发送方收到确认帧后才一定）向前滑动。
2. 不同协议的滑动窗口大小有所差别：
   - 停止-等待协议：发送窗口大小=1，接收窗口大小=1
   - 后退N帧协议：2^n^-1>发送窗口大小>1,接收窗口大小=1
   - 选择重传协议：发送窗口大小>1,接收窗口大小>1
   - 

#### 可靠传输机制

1. **确认**
   - **捎带确认**：有些情况下为了提高传输率，将确认捎带在一个回复帧中。

2. **超时重传**

##### 自动重传请求（ARQ）：

1. 停止-等待
2. 后退N帧
3. 选择性重传



#### 性能指标

==常用于计算题==

##### 信道利用率

发送方在一个发送周期内,有效地发送数据所需要的时间占整个发送周期的比率。

![image-20220625160211760](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251602852.png)

##### 信道吞吐率

**信道吞吐率**=信道利用率*发送方的发送速率



#### ==停止-等待协议==

超时计时器：每次发送一个帧就启动一个计时器。

超时计时器设置的重传时间应当比帧传输的平局RTT更长一些

发送完一个帧后，必须保留他的副本。

数据帧和确认帧必须编号，编号只需1bit

##### 应用情况

###### 无差错

![image-20220625160802806](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251608709.png)

###### 数据帧丢失或检测到帧出错

![image-20220625161037740](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251610834.png)



###### ACK丢失



![image-20220625161404593](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251614697.png)

###### ACK迟到

![QQ截图20220625161449](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251616868.jpg)



#### ==后退N帧协议（GBN）==

GBN滑动窗口

![QQ截图20220625162517](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251626433.jpg)



##### GBN应用情况

![QQ截图20220625164433](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251644552.jpg)



##### 发送方

###### 1.  上层的调用

上层要发送数据时，发送方先检查发送窗口是否已满，如果**未满**，则产生一个帧并将其发送;如果窗口已满发送方只需将数据返回给上层，暗示上层**窗口已满**。上层等一会再发送。(实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧)。

###### 2. 收到ACK

GBN协议中，对n号帧的确认采用==累积确认==的方式，标明接收方已经收到n号帧和它之前的全部帧。

###### 3. 超时事件

协议的名字为后退N帧/回退N帧，来源于出现丢失和时延过长帧时发送方的行为。就像在停等协议中一样，定时器将再次用于恢复数据帧或确认帧的丢失。如果出现超时，发送方重传==所有已发送但未被确认==的帧。

只有一个定时器



##### 接收方

1. 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层。

2. ==其余情况都丢弃帧==，并为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护一个信息: expectedseqnum (下一个按序接收的帧序号)。



##### 滑动窗口长度

若采用n个比特对帧编号，那么**发送窗口**的尺寸W.应满足:==1≤W≤2^n^-1==。因为发送窗口尺寸过大，就会使得**接收方**无法区别新帧和旧帧。

2^n^为窗口总数

**注意区分窗口总数和窗口大小**



##### GBN协议性能分析

优点：因连续发送数据帧而提高了信道利用率。

缺点：在重传时必须把原来已经正确传送的数据帧重传，是传送效率降低。



#### 选择重传协议（SR）

##### 滑动窗口机制

![QQ截图20220626143807](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261438627.jpg)



##### NAK机制

一旦接收方怀疑帧出错

##### 发送方

###### 上层的调用

从上层收到数据后，**SR**发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，则发送数据帧;否则就像**GBN**一样，要么将数据**缓存**，要么**返回给上层**之后再传输。

###### 收到ACK

如果收到**ACK**，加入该帧序号在窗口内，则SR发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口对应的序号），则窗口向前移动到具有**最小序号的未确认帧处**。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。

###### 超时事件

​		**每个帧**都有自己的定时器，一个超时事件发生后只重传一个帧。



##### 接收方

###### 接受所有帧（窗口内的帧）

SR接收方将**确认一个正确接收的帧**而==不管其是否按序==。失序的帧将被缓存，并返回给发送方一个该帧的确认帧【**收谁确认谁**】，直到所有帧（即序号更小的帧）皆被收到为止，这时才可以将一批帧按序交付给上层，然后**向前移动滑动窗口**。

如果收到了窗口序号外(小于窗口下界)的帧，就返回一个ACK。



##### 滑动窗口大小

发送窗口最好等于接收窗口。（大了会溢出，小了没意义)

W~Tmax~=W~Rmax~=2^(n-1)^，n表示n个比特对帧编号

W~Tmax~+W~Rmax~≤2^n^ 

##### SR应用情况

![QQ截图20220626142813](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261428013.jpg)

### 介质访问控制

#### 点对点链路

两个相邻节点通过一个链路相连，没有第三者。应用:PPP协议，常用于**广域网**。

#### 广播式链路

所有主机共享通信介质。

应用:早期的总线以太网、无线局域网，常用于**局域网**。典型拓扑结构:总线型、星型(逻辑总线型)



#### 信道划分介质访问控制

基于多路复用技术划分资源。

**网络负载重**:共享信道效率高，且公平

**网络负载轻**:共享信道效率低

##### 码分复用



==流程==

加入A的码片为00011011，则A站发送00011011就表示发送了比特1，发送了11100100就表示发送了比特0

1. 多个站点同时发送数据的时候，要求各个站点码片序列相互正交，规格化内积为0。

   ![QQ截图20220626160842](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261608049.jpg)

2. 两个向量到了公共信道上，线性相加。

   图中B传输的比特为0，所以码片序列是-T。

   ![QQ截图20220626161007](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261610291.jpg)

3. 数据分离:合并的数据和源站规格化内积。

   1代表传输的比特为1,-1代表传输的比特为0

   ![QQ截图20220626161053](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261610411.jpg)



#### 随机访问介质访问控制

用户根据意愿随机发送信息，发送信息时可独占信道带宽。

**网络负载重**:产生冲突开销

**网络负载轻**:共享信道效率高，单个结点可利用信道全部带宽

##### CSMA协议（载波侦听多路访问）end

###### 概念-原理

**全名**：Carrier Sense Multiple Access

**CS**:载波侦听/监听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据。

**监听原理**：当几个站同时在总线上发送数据时，总线上的信号**电压摆动值**将会增大（互相叠加)。当一个站检测到的信号电压摆动值超过一定门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞，即发生了冲突。

**MA**:多点接入，表示许多计算机以多点接入的方式连接在一根总线上。适用于==总线型网络==。

**协议思想**：发送帧之前，**监听**信道

**监听结果**：

1. 信道空闲：发送完整帧
2. 信道忙：推迟发送

**冲突原因**：因为数据传输有传播时延（三种CMSA共有原因）。结点A开始发送数据时，结点B也正好有数据要发送，但这时结点A发出数据的信号还未到达结点B，结点B侦听到信道空闲，于是立即发送数据，结果必然导致冲突。

###### 1-坚持CSMA

坚持指的是对于监听信道==忙==之后的坚持

**1-坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。
2. ==空闲则直接传输，不必等待。==
3. ==忙则一直监听，直到空闲马上传输。==
4. 如果有冲突(==一段时间内未收到肯定回复==），则等待一个随机长的时间再监听，重复上述过程。

**优点**:只要媒体空闲，站点就马上发送，避免了媒体利用率的损失。

**缺点**:假如有两个或两个以上的站点有数据要发送，冲突就不可避。例如，结点A正在发送数据时，结点B和C也准备发送数据，侦听到信道忙，于是坚持侦听，结果当结点A一发送完毕，结点B和C就会立即发送数据，同样导致冲突。

###### 非坚持CMSA

非坚持指的是对于监听信道==忙==之后就不继续监听，之后随机监听。

**非坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。

2. ==空闲则直接传输，不必等待。==

3. ==忙则等待一个随机的时间之后再进行监听。==

**优点**:采用随机的重发延迟时间可以减少冲突发生的可能性。

**缺点**:可能存在大家都在延迟等待过程中，使得信道仍可能处于空闲状态，信道使用率降低。

###### p-坚持CSMA

p-坚持指的是对于监听信道==空闲==的处理。

==只用于时分信道。==

**p-坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。

2. ==空闲则以p概率直接传输，不必等待;概率1-p等待到下一个时间槽再传输。==
3. ==忙则持续监听直到信道空闲再以p概率发送。==

3. ==若冲突则等到下一个时间槽开始再监听并重复上述过程。==

**优点**:既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间的这种方案。

p-坚持CSMA协议是前两种CSMA协议的折中方案。

###### 三种CMSA对比及总结

| 信道状态 | 1-坚持       | 非坚持                               | p-坚持                                     |
| -------- | ------------ | ------------------------------------ | ------------------------------------------ |
| 空闲     | 立即发送数据 | 立即发送数据                         | 以概率p发送数据，以概率1-p推迟到下一个时隙 |
| 忙       | 继续坚持侦听 | 放弃侦听，等待一个随机的时间后再侦听 | 持续侦听，直到信道空闲                     |

**三者共有缺点**：无法直接检测冲突，发生冲突后还是要坚持把数据帧发送完，造成浪费。

都会因为传播时延产生冲突。

##### CSMA/CD协议

###### 概念

**英文**：Carrier Sense Multiple Access with Collision Detection

**工作流程**概括：先听后发，边听边发，冲突停发，随机重发

CS和MA部分同CSMA协议

**CD**:碰撞检测（冲突检测)，“**边发送边监听**”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。适用于==半双工通信==（个人理解：既然CSMA/CD只用于半双工，那CSMA应该也是半双工）

**冲突原因**：同CSMA，因为传播时延。

###### 争用期

如图可知，站A在发送帧后至多经过时间2$\tau $(端到端传播时延的2倍）就能知道所发送的帧有没有发生碰撞（当$\delta $→0时)。因此把以太网端到端往返时间2$\tau $称为**争用期**(又称**冲突窗口**或**碰撞窗口**)。每个站在自己发送数据之后的一小段时间内，存在发生碰撞的可能性，==只有经过争用期这段时间还未检测到碰撞时，才能确定这次发送不会发生碰撞==。

![QQ截图20220627193829](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206271938809.jpg)

###### 最小帧长

**问题背景**：A站发了一个很短的帧，但发生了碰撞，不过帧在发送完毕后才检测到发生碰撞，没法停止发送。

为了确保发送站在发送数据的同时能检测到可能存在的碰撞，需要在发送完帧之前就能收到自己发送出去的数据，即==帧的传输时延至少要两倍手信号在总线中的传播时延==，所以CSMA/CD总线网中的所有==数据帧都必须要大于一个最小帧长==。任何站点收到帧长小于最小帧长的帧时，就把它当作无效帧立即丢弃。最小帧长的计算公式为

<center>最小帧长=总线传播时延*数据传输速率*2</center>`

###### 截断二进制指数规避算法（用以重传时机）

**算法原理（流程）**

1. 确定基本退避（推迟）时间为争用期2$\tau $。

2. 定义参数k，它等于==重传次数===，但k不超过10，即k=min[重传次数，10]。当重传次数不超过10时，k等于重传次数;当重传次数大于10时，k就不再增大而一直等于10。

3. 从离散的整数集合==[0,1,,2^k^-1]==中随机取出一个数r，重传所需要退避的时间就是==r倍的基本退避时间==，即2r$\tau $ 。

4. 当重传达==16次==仍不能成功时，说明网络太拥挤，认为此帧永远无法正确发出，抛弃此帧并向高层报告出错。

**例子：**

1. 第一次重传，k=1，r从{0，1}选;
   重传推迟时间为0或2r，在这两个时间中随机选一个﹔

2. 若再次碰撞，则在第二次重传时, k=2，r从{0，1，2，3}选;重传推迟时间为0或2t或4r或6t，在这四个时间中随机选一个;

3. 若再次碰撞，则第三次重传时，k=3，r从{0，1，2，3，4，5，6，7}选.....

**优点**：使用截断二进制指数退避算法可使重传需要推迟的平均时间随重传次数的增大而增大(这也称**动态退避**)，因而能降低发生碰撞的概率，有利于整个系统的稳定。



##### CSMA/CA协议

###### 概念

不同于CSMA/CD，CSMA/CA应用于==无线网==环境。

CA为碰撞避免（Collision Avoidance）

**无线网中存在的问题**

1. 接收信号的强度往往会远小于发送信号的强度，且在无线介质上信号强度的动态变化范围很大，因此若要实现碰撞检测，则硬件上的花费就会过大。

2. 在无线通信中，并非所有的站点都能够听见对方，即存在“==隐蔽站==”问题。

###### 帧间间隔

为了尽量避免碰撞，802.11规定，==所有的站完成发送后，必须再等待一段很短的时间（继续监听）==才能发送下一帧。这段时间称为帧间间隔（InterFrame Space，IFS)。帧间间隔的长短取决于该站要发送的帧的类型。802.11使用了3种IFS:

1. **SIFS**（短IFS):最短的IFS，用来分隔属于一次对话的各帧，使用SIFS的帧类型有ACK帧、CTS帧、分片后的数据帧，以及所有回答AP探询的帧等。
2. **PIFS**（点协调IFS):中等长度的IFS，在PCF操作中使用。
3. **DIFS**（分布式协调IFS):最长的IFS，用于异步帧竞争访问的时延。

###### 无RTS的流程

1. 若站点最初有数据要发送（而不是发送不成功再进行重传)，且检测到信道空闲，在等待时间==DIFS==后，就发送整个数据帧。

2. 否则，站点执行CSMA/CA退避算法，选取一个随机回退值。一旦检测到信道忙，退避计时器就保持不变。只要信道空闲，退避计时器就进行倒计时。

3. 当退避计时器减到0时（这时信道只可能是空闲的)，站点就发送整个帧并等待确认。

4. 发送站若收到确认，就知道己发送的帧被目的站正确接收。这时如果要发送第二帧，就要从步骤2）开始。

若发送站在规定时间内没有收到确认帧ACK（由重传计时器控制)，就必须重传该帧，再次使用CSMA/CA 协议争用该信道，直到收到确认，或经过若干次重传失败后放弃发送。

###### **隐蔽站问题**

​	站A和B都在AP的覆盖范围内，但A和B相距较远，彼此都听不见对方。当A和B检测到信道空闲时，都向AP发送数据，导致碰撞的发生，这就是隐蔽站问题。

**为了避免该问题，802.11允许发送站对信道进行预约（可选择，不一定要这么做）**

###### **有RTS的流程**

1. 发送数据前，先检测信道是否空闲。

2. 空闲则发出RTS (request to send)，RTS包括**发射端的地址、接收端的地址、下一份数据将持续发送的时间**等信息;信道忙则等待。

3. 接收端收到RTS后，将响应并广播CTS (clear to send)控制帧，该帧也能被其范围内的其它站点听到，其它站点收到后在CTS帧指明的时间内会抑制发送 。

   CTS帧的**目的**：

   1. 给源站明确的发送许可
   2. 指示其他站点在预约期内不要发送

4. 发送端收到CTS后，开始发送数据帧（同时**预约信道**:发送方告知其他站点自己要传多久数据）。接收端收到数据帧后，将用CRC来检验数据是否正确，正确则==响应ACK帧==。

5. 发送方收到ACK就可以进行下一个数据帧的发送，若没有则一直==重传至规定重发次数为止==(采用**二进制指数退避算法**来确定随机的推迟时间)。



###### CSMA/CD与CSMA/CA比较

**相同点**：

CSMA/CD与CSMA/CA机制都从属于CSMA的思路，其核心是先听再说。换言之，两个在接入信道之前都须要进行监听。当发现信道空闲后，才能进行接入。

**不同点**：

1. 传输介质不同:CSMA/CD用于总线式以太网【有线】，而CSMA/CA用于无线局域网【无线】。

2. 载波检测方式不同:因传输介质不同，CSMA/CD与CSMA/CA的检测方式也不同。CSMA/CD通过电缆中电压的变化来检测，当数据发生碰撞时，电缆中的电压就会随着发生变化；而CSMA/CA采用能量检测(ED) 、载波检测(CS）和能量载波混合检测三种检测信道空闲的方式。

3. 3.CSMA/CD检测冲突，CSMA/CA避免冲突，二者出现冲突后都会进行有上限的重传。



#### 轮询访问

既要不产生冲突，又要发送时占全部带宽。 

##### 轮询协议

主节点轮流邀请（以帧的形式）从属节点发送数据。

**存在的问题**：

1. 轮询开销
2. 等待延时
3. 单点故障

##### 令牌传递协议

