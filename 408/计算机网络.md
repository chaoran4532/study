##  链路层

### 可靠传输



#### 滑动窗口

##### ==特性==

1. 只有接受窗口向前滑动（同时接收方发送了确认帧）时，发送窗口才有可能（只有发送方收到确认帧后才一定）向前滑动。
2. 不同协议的滑动窗口大小有所差别：
   - 停止-等待协议：发送窗口大小=1，接收窗口大小=1
   - 后退N帧协议：2^n^-1>发送窗口大小>1,接收窗口大小=1
   - 选择重传协议：发送窗口大小>1,接收窗口大小>1
   - 

#### 可靠传输机制

1. **确认**
   - **捎带确认**：有些情况下为了提高传输率，将确认捎带在一个回复帧中。

2. **超时重传**

##### 自动重传请求（ARQ）：

1. 停止-等待
2. 后退N帧
3. 选择性重传



#### 性能指标

==常用于计算题==

##### 信道利用率

发送方在一个发送周期内,有效地发送数据所需要的时间占整个发送周期的比率。

![image-20220625160211760](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251602852.png)

##### 信道吞吐率

**信道吞吐率**=信道利用率*发送方的发送速率



#### ==停止-等待协议==

超时计时器：每次发送一个帧就启动一个计时器。

超时计时器设置的重传时间应当比帧传输的平局RTT更长一些

发送完一个帧后，必须保留他的副本。

数据帧和确认帧必须编号，编号只需1bit

##### 应用情况

###### 无差错

![image-20220625160802806](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251608709.png)

###### 数据帧丢失或检测到帧出错

![image-20220625161037740](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251610834.png)



###### ACK丢失



![image-20220625161404593](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251614697.png)

###### ACK迟到

![QQ截图20220625161449](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251616868.jpg)



#### ==后退N帧协议（GBN）==

GBN滑动窗口

![QQ截图20220625162517](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251626433.jpg)



##### GBN应用情况

![QQ截图20220625164433](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206251644552.jpg)



##### 发送方

###### 1.  上层的调用

上层要发送数据时，发送方先检查发送窗口是否已满，如果**未满**，则产生一个帧并将其发送;如果窗口已满发送方只需将数据返回给上层，暗示上层**窗口已满**。上层等一会再发送。(实际实现中，发送方可以缓存这些数据，窗口不满时再发送帧)。

###### 2. 收到ACK

GBN协议中，对n号帧的确认采用==累积确认==的方式，标明接收方已经收到n号帧和它之前的全部帧。

###### 3. 超时事件

协议的名字为后退N帧/回退N帧，来源于出现丢失和时延过长帧时发送方的行为。就像在停等协议中一样，定时器将再次用于恢复数据帧或确认帧的丢失。如果出现超时，发送方重传==所有已发送但未被确认==的帧。

只有一个定时器



##### 接收方

1. 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层。

2. ==其余情况都丢弃帧==，并为最近按序接收的帧重新发送ACK。接收方无需缓存任何失序帧，只需要维护一个信息: expectedseqnum (下一个按序接收的帧序号)。



##### 滑动窗口长度

若采用n个比特对帧编号，那么**发送窗口**的尺寸W.应满足:==1≤W≤2^n^-1==。因为发送窗口尺寸过大，就会使得**接收方**无法区别新帧和旧帧。

2^n^为窗口总数

**注意区分窗口总数和窗口大小**



##### GBN协议性能分析

优点：因连续发送数据帧而提高了信道利用率。

缺点：在重传时必须把原来已经正确传送的数据帧重传，是传送效率降低。



#### 选择重传协议（SR）

##### 滑动窗口机制

![QQ截图20220626143807](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261438627.jpg)



##### NAK机制

一旦接收方怀疑帧出错

##### 发送方

###### 上层的调用

从上层收到数据后，**SR**发送方检查下一个可用于该帧的序号，如果序号位于发送窗口内，则发送数据帧;否则就像**GBN**一样，要么将数据**缓存**，要么**返回给上层**之后再传输。

###### 收到ACK

如果收到**ACK**，加入该帧序号在窗口内，则SR发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下界（最左边第一个窗口对应的序号），则窗口向前移动到具有**最小序号的未确认帧处**。如果窗口移动了并且有序号在窗口内的未发送帧，则发送这些帧。

###### 超时事件

​		**每个帧**都有自己的定时器，一个超时事件发生后只重传一个帧。



##### 接收方

###### 接受所有帧（窗口内的帧）

SR接收方将**确认一个正确接收的帧**而==不管其是否按序==。失序的帧将被缓存，并返回给发送方一个该帧的确认帧【**收谁确认谁**】，直到所有帧（即序号更小的帧）皆被收到为止，这时才可以将一批帧按序交付给上层，然后**向前移动滑动窗口**。

如果收到了窗口序号外(小于窗口下界)的帧，就返回一个ACK。



##### 滑动窗口大小

发送窗口最好等于接收窗口。（大了会溢出，小了没意义)

W~Tmax~=W~Rmax~=2^(n-1)^，n表示n个比特对帧编号

W~Tmax~+W~Rmax~≤2^n^ 

##### SR应用情况

![QQ截图20220626142813](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261428013.jpg)

### 介质访问控制

#### 点对点链路

两个相邻节点通过一个链路相连，没有第三者。应用:PPP协议，常用于**广域网**。

#### 广播式链路

所有主机共享通信介质。

应用:早期的总线以太网、无线局域网，常用于**局域网**。典型拓扑结构:总线型、星型(逻辑总线型)

#### 介质访问控制方法分类

==信道划分介质访问控制==、==随机访问介质访问控制==、==轮询访问介质控制==

前者是==静态划分信道==，后两者是==动态划分信道==



#### 信道划分介质访问控制

基于多路复用技术划分资源。

**网络负载重**:共享信道效率高，且公平

**网络负载轻**:共享信道效率低

##### 码分复用



==流程==

加入A的码片为00011011，则A站发送00011011就表示发送了比特1，发送了11100100就表示发送了比特0

1. 多个站点同时发送数据的时候，要求各个站点码片序列相互正交，规格化内积为0。

   ![QQ截图20220626160842](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261608049.jpg)

2. 两个向量到了公共信道上，线性相加。

   图中B传输的比特为0，所以码片序列是-T。

   ![QQ截图20220626161007](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261610291.jpg)

3. 数据分离:合并的数据和源站规格化内积。

   1代表传输的比特为1,-1代表传输的比特为0

   ![QQ截图20220626161053](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206261610411.jpg)



#### 随机访问介质访问控制

用户根据意愿随机发送信息，发送信息时可独占信道带宽。

**网络负载重**:产生冲突开销

**网络负载轻**:共享信道效率高，单个结点可利用信道全部带宽

##### CSMA协议（载波侦听多路访问）end

###### 概念-原理

**全名**：Carrier Sense Multiple Access

**CS**:载波侦听/监听，每一个站在发送数据之前要检测一下总线上是否有其他计算机在发送数据。

**监听原理**：当几个站同时在总线上发送数据时，总线上的信号**电压摆动值**将会增大（互相叠加)。当一个站检测到的信号电压摆动值超过一定门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞，即发生了冲突。

**MA**:多点接入，表示许多计算机以多点接入的方式连接在一根总线上。适用于==总线型网络==。

**协议思想**：发送帧之前，**监听**信道

**监听结果**：

1. 信道空闲：发送完整帧
2. 信道忙：推迟发送

**冲突原因**：因为数据传输有传播时延（三种CMSA共有原因）。结点A开始发送数据时，结点B也正好有数据要发送，但这时结点A发出数据的信号还未到达结点B，结点B侦听到信道空闲，于是立即发送数据，结果必然导致冲突。

###### 1-坚持CSMA

坚持指的是对于监听信道==忙==之后的坚持

**1-坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。
2. ==空闲则直接传输，不必等待。==
3. ==忙则一直监听，直到空闲马上传输。==
4. 如果有冲突(==一段时间内未收到肯定回复==），则等待一个随机长的时间再监听，重复上述过程。

**优点**:只要媒体空闲，站点就马上发送，避免了媒体利用率的损失。

**缺点**:假如有两个或两个以上的站点有数据要发送，冲突就不可避。例如，结点A正在发送数据时，结点B和C也准备发送数据，侦听到信道忙，于是坚持侦听，结果当结点A一发送完毕，结点B和C就会立即发送数据，同样导致冲突。

###### 非坚持CMSA

非坚持指的是对于监听信道==忙==之后就不继续监听，之后随机监听。

**非坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。

2. ==空闲则直接传输，不必等待。==

3. ==忙则等待一个随机的时间之后再进行监听。==

**优点**:采用随机的重发延迟时间可以减少冲突发生的可能性。

**缺点**:可能存在大家都在延迟等待过程中，使得信道仍可能处于空闲状态，信道使用率降低。

###### p-坚持CSMA

p-坚持指的是对于监听信道==空闲==的处理。

==只用于时分信道。==

**p-坚持CSMA思想:**

1. 如果一个主机要发送消息，那么它先监听信道。

2. ==空闲则以p概率直接传输，不必等待;概率1-p等待到下一个时间槽再传输。==
3. ==忙则持续监听直到信道空闲再以p概率发送。==

4. ==若冲突则等到下一个时间槽开始再监听并重复上述过程。==

**优点**:既能像非坚持算法那样减少冲突，又能像1-坚持算法那样减少媒体空闲时间的这种方案。

p-坚持CSMA协议是前两种CSMA协议的折中方案。

###### 三种CMSA对比及总结

| 信道状态 | 1-坚持       | 非坚持                               | p-坚持                                     |
| -------- | ------------ | ------------------------------------ | ------------------------------------------ |
| 空闲     | 立即发送数据 | 立即发送数据                         | 以概率p发送数据，以概率1-p推迟到下一个时隙 |
| 忙       | 继续坚持侦听 | 放弃侦听，等待一个随机的时间后再侦听 | 持续侦听，直到信道空闲                     |

**三者共有缺点**：无法直接检测冲突，发生冲突后还是要坚持把数据帧发送完，造成浪费。

都会因为传播时延产生冲突。

##### CSMA/CD协议

###### 概念

**英文**：Carrier Sense Multiple Access with Collision Detection

**工作流程**概括：先听后发，边听边发，冲突停发，随机重发

CS和MA部分同CSMA协议

**CD**:碰撞检测（冲突检测)，“**边发送边监听**”，适配器边发送数据边检测信道上信号电压的变化情况，以便判断自己在发送数据时其他站是否也在发送数据。适用于==半双工通信==（个人理解：既然CSMA/CD只用于半双工，那CSMA应该也是半双工）

**冲突原因**：同CSMA，因为传播时延。

###### 争用期

如图可知，站A在发送帧后至多经过时间2$\tau $(端到端传播时延的2倍）就能知道所发送的帧有没有发生碰撞（当$\delta $→0时)。因此把以太网端到端往返时间2$\tau $称为**争用期**(又称**冲突窗口**或**碰撞窗口**)。每个站在自己发送数据之后的一小段时间内，存在发生碰撞的可能性，==只有经过争用期这段时间还未检测到碰撞时，才能确定这次发送不会发生碰撞==。

![QQ截图20220627193829](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206271938809.jpg)

###### 最小帧长

**问题背景**：A站发了一个很短的帧，但发生了碰撞，不过帧在发送完毕后才检测到发生碰撞，没法停止发送。

为了确保发送站在发送数据的同时能检测到可能存在的碰撞，需要在发送完帧之前就能收到自己发送出去的数据，即==帧的传输时延至少要两倍手信号在总线中的传播时延==，所以CSMA/CD总线网中的所有==数据帧都必须要大于一个最小帧长==。任何站点收到帧长小于最小帧长的帧时，就把它当作无效帧立即丢弃。最小帧长的计算公式为

<center>最小帧长=总线传播时延*数据传输速率*2</center>`

###### 截断二进制指数规避算法（用以重传时机）

**算法原理（流程）**

1. 确定基本退避（推迟）时间为争用期2$\tau $。

2. 定义参数k，它等于==重传次数===，但k不超过10，即k=min[重传次数，10]。当重传次数不超过10时，k等于重传次数;当重传次数大于10时，k就不再增大而一直等于10。

3. 从离散的整数集合==[0,1,,2^k^-1]==中随机取出一个数r，重传所需要退避的时间就是==r倍的基本退避时间==，即2r$\tau $ 。

4. 当重传达==16次==仍不能成功时，说明网络太拥挤，认为此帧永远无法正确发出，抛弃此帧并向高层报告出错。

**例子：**

1. 第一次重传，k=1，r从{0，1}选;
   重传推迟时间为0或2r，在这两个时间中随机选一个﹔

2. 若再次碰撞，则在第二次重传时, k=2，r从{0，1，2，3}选;重传推迟时间为0或2t或4r或6t，在这四个时间中随机选一个;

3. 若再次碰撞，则第三次重传时，k=3，r从{0，1，2，3，4，5，6，7}选.....

**优点**：使用截断二进制指数退避算法可使重传需要推迟的平均时间随重传次数的增大而增大(这也称**动态退避**)，因而能降低发生碰撞的概率，有利于整个系统的稳定。



##### CSMA/CA协议

###### 概念

不同于CSMA/CD，CSMA/CA应用于==无线网==环境。

CA为碰撞避免（Collision Avoidance）

**无线网中存在的问题**

1. 接收信号的强度往往会远小于发送信号的强度，且在无线介质上信号强度的动态变化范围很大，因此若要实现碰撞检测，则硬件上的花费就会过大。

2. 在无线通信中，并非所有的站点都能够听见对方，即存在“==隐蔽站==”问题。

###### 帧间间隔

为了尽量避免碰撞，802.11规定，==所有的站完成发送后，必须再等待一段很短的时间（继续监听）==才能发送下一帧。这段时间称为帧间间隔（InterFrame Space，IFS)。帧间间隔的长短取决于该站要发送的帧的类型。802.11使用了3种IFS:

1. **SIFS**（短IFS):最短的IFS，用来分隔属于一次对话的各帧，使用SIFS的帧类型有ACK帧、CTS帧、分片后的数据帧，以及所有回答AP探询的帧等。
2. **PIFS**（点协调IFS):中等长度的IFS，在PCF操作中使用。
3. **DIFS**（分布式协调IFS):最长的IFS，用于异步帧竞争访问的时延。

###### 无RTS的流程

1. 若站点最初有数据要发送（而不是发送不成功再进行重传)，且检测到信道空闲，在等待时间==DIFS==后，就发送整个数据帧。

2. 否则，站点执行CSMA/CA退避算法，选取一个随机回退值。一旦检测到信道忙，退避计时器就保持不变。只要信道空闲，退避计时器就进行倒计时。

3. 当退避计时器减到0时（这时信道只可能是空闲的)，站点就发送整个帧并等待确认。

4. 发送站若收到确认，就知道己发送的帧被目的站正确接收。这时如果要发送第二帧，就要从步骤2）开始。

若发送站在规定时间内没有收到确认帧ACK（由重传计时器控制)，就必须重传该帧，再次使用CSMA/CA 协议争用该信道，直到收到确认，或经过若干次重传失败后放弃发送。

###### **隐蔽站问题**

​	站A和B都在AP的覆盖范围内，但A和B相距较远，彼此都听不见对方。当A和B检测到信道空闲时，都向AP发送数据，导致碰撞的发生，这就是隐蔽站问题。

**为了避免该问题，802.11允许发送站对信道进行预约（可选择，不一定要这么做）**

###### **有RTS的流程**

1. 发送数据前，先检测信道是否空闲。

2. 空闲则发出RTS (request to send)，RTS包括**发射端的地址、接收端的地址、下一份数据将持续发送的时间**等信息;信道忙则等待。

3. 接收端收到RTS后，将响应并广播CTS (clear to send)控制帧，该帧也能被其范围内的其它站点听到，其它站点收到后在CTS帧指明的时间内会抑制发送 。

   CTS帧的**目的**：

   1. 给源站明确的发送许可
   2. 指示其他站点在预约期内不要发送

4. 发送端收到CTS后，开始发送数据帧（同时**预约信道**:发送方告知其他站点自己要传多久数据）。接收端收到数据帧后，将用CRC来检验数据是否正确，正确则==响应ACK帧==。

5. 发送方收到ACK就可以进行下一个数据帧的发送，若没有则一直==重传至规定重发次数为止==(采用**二进制指数退避算法**来确定随机的推迟时间)。



###### CSMA/CD与CSMA/CA比较

**相同点**：

CSMA/CD与CSMA/CA机制都从属于CSMA的思路，其核心是先听再说。换言之，两个在接入信道之前都须要进行监听。当发现信道空闲后，才能进行接入。

**不同点**：

1. 传输介质不同:CSMA/CD用于总线式以太网【有线】，而CSMA/CA用于无线局域网【无线】。

2. 载波检测方式不同:因传输介质不同，CSMA/CD与CSMA/CA的检测方式也不同。CSMA/CD通过电缆中电压的变化来检测，当数据发生碰撞时，电缆中的电压就会随着发生变化；而CSMA/CA采用能量检测(ED) 、载波检测(CS）和能量载波混合检测三种检测信道空闲的方式。

3. 3.CSMA/CD检测冲突，CSMA/CA避免冲突，二者出现冲突后都会进行有上限的重传。



#### 轮询访问

既要不产生冲突，又要发送时占全部带宽。 

##### 轮询协议

主节点轮流邀请（以帧的形式）从属节点发送数据。

**存在的问题**：

1. 轮询开销
2. 等待延时
3. 单点故障

##### 令牌传递协议



### 局域网

#### 局域网基本概念和体系结构

局域网(Local Area Network):简称LAN，是指在**某一区域内**由多台计算机互联成的计算机组，使用==广播信道==。

##### 特点：

1. 覆盖的地理范围较小，只在一个相对独立的局部范围内联，如一座或集中的建筑群内。
2. 使用专门铺设的传输介质（双绞线、同轴电缆）进行联网，数据传输速率高（10Mb/s~10Gb/s)。

3. 通信延迟时间短，误码率低，可靠性较高。

4. 各站为平等关系，共享传输信道。

5. 多采用分布式控制和广播式通信，能进行广播和组播。

决定局域网的主要要素为:==网络拓扑==，==传输介质==与==介质访问控制==方法。



##### 传输介质

双绞线，铜缆，光纤

== 双绞线为主流传输介质==



##### 拓扑结构

###### 星型结构

###### 环形结构

###### 总线型结构

###### 树形结构



##### 介质访问控制方法

###### CSMA/CD

用于总线型局域网

###### 令牌总线

用于总线型局域网

###### 令牌环

用于环形局域网



##### 局域网种类（拓扑实现）

###### 以太网 （IEEE 802.3）

以太网是应用最为广泛的局域网，包括标准以太网(10Mbps)、快速以太网（100Mbps) ,千兆以太网（1000 Mbps）和10G以太网，它们都符合IEEE802.3系列标准规范。==逻辑拓扑总线型，物理拓扑是星型或拓展星型==。==使用CSMA/CD.==

###### 令牌环（IEEE 802.5）

==物理上采用了星形拓扑结构，逻辑上是环形拓扑结构==。

###### FDDI（光纤分布数字接口，IEEE 802.8）

==物理上采用了双环拓扑结构，逻辑上是环形拓扑结构。==

###### 无线局域网（IEEE 802.11）



##### MAC子层和LLC子层

![QQ截图20220629145112](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291514091.jpg)

IEEE 802标准所描述的局域网参考模型只对应OSI参考模型的==数据链路层与物理层==，它将数据链路层划分为逻辑链路层LLC子层和介质访问控制MAC子层。

###### LLC

LLC负责识别==网络层==协议，然后对它们进行封装。LLC报头告诉数据链路层一旦帧被接收到时，应当对数据包做何处理。为网络层提供服务:无确认无连接、面向连接、带确认无连接、高速传送。

###### MAC

MAC子层的主要功能包括数据帧的封装/卸装，帧的寻址和识别，帧的接收与发送，链路的管理，帧的差错控制等。MAC子层的存在屏蔽了不同物理链路种类的差异性。

#### ==以太网与IEEE802.3==

##### 概述

以太网(Ethernet)指的是由Xerox公司创建并由Xerox、Intel和DEC公司联合开发的==基带总线局域网规范==，是当今现有局域网采用的最通用的通信协议标准。

1. ==逻辑==上==采用总线形拓扑结构==
2. ==使用曼切斯特编码==
3. ==使用CSMA/CD==



##### **两个标准**：

###### **DIX Ethernet V2**

###### **IEEE802.3**

两个标准有细微差别

通常将802.3局域网简称为以太网



##### 以太网提供无连接，不可靠服务

**无连接**:发送方和接收方之间无“握手过程”。

**不可靠**:不对发送方的数据帧编号，接收方==不向发送方进行确认==，差错帧直接丢弃，差错纠正由高层负责。

以太网只实现==无差错接收==（出错丢弃），不实现==可靠传输==。



##### 传输介质与拓扑结构发展

![QQ截图20220629152525](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291525336.jpg)

10BASE-T是==重点==，如今最常使用的是==10BASE-T==。

##### 10BASE-T

1. ==逻辑上总线型，物理上星型==，

   2. 传输速率==10m/s==
   2. CSMA/CD

##### 适配器与MAC地址

计算机与外界有局域网的连接是通过==通信适配器==的。又称网络接口板或网络接口卡。

适配器上装有处理器和存储器（包括RAM和ROM）。ROM上有计算机硬件地址==MAC地址==。

MAC地址又称物理地址，硬件地址。

###### MAC地址

MAC地址:每个适配器有一个全球唯一的48位二进制地址，前24位代表厂家（由IEEE规定)，后24位厂家自己指定。常用6个十六进制数表示，如02-60-8c-e4-b1-21。

##### ==以太网MAC帧==

分为IEEE802.3格式和V2标准的MAC帧格式

最常用的MAC帧是以以太网V2的格式。

![QQ截图20220629153355](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291534168.jpg)



###### 前导码

7字节是前同步码，1字节 帧开始定界符。

###### 不需要结束符

MAC地址==不需要帧结束符==，因为以太网中，各帧之间必须有一定的间隙。但==不要误以为以太网MAC帧不需要尾部==。

###### **帧长度**

帧最小长度为64B，所以最小数据为46B，不足时自动填充。

帧最长为1518B，数据为1500B，即==MTU为1500B==

###### FCS：校验码

不校验前导码，其它都校验

###### 802.3帧格式

用长度域代替类型，但实际中都表示，帧最长为1500B，所以1-1500表示长度，1501-65535表示类型



##### 高速以太网

速度超过100Mb/s的以太网为高速以太网。==高速以太网的帧格式和普通以太网的帧格式相同==。

###### 100BASE-T

在==双绞线==上传送==100Mb/s==基带信号的星型拓扑以太网，仍使用IEEE802.3的==CSMA/CD==协议。支持==全双工和半双工==，可在全双工方式下工作而无冲突。**在全双工下不使用CSMA/CD**

###### 吉比特以太网

在==光纤或双绞线==上传送==1Gb/s==信号。
支持全双工（不使用CSMA/CD）和半双工（使用CSMA/CD），可在全双工方式下工作而无冲突。

###### 10吉比特以太网

10吉比特以太网在光纤上传送10Gb/s信号。

只使用光纤，只支持全双工。



#### IEEE802.11无限局域网

##### 802.11的MAC帧头格式

![QQ截图20220629155815](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291559810.jpg)



![QQ截图20220629160023](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291600200.jpg)



##### 无线局域网的分类

###### 1. 有固定基础设施无线局域网

![QQ截图20220629160144](../../Desktop/%E6%88%AA%E5%9B%BE/QQ%E6%88%AA%E5%9B%BE20220629160144.jpg)

###### 2. 无固定基础设施无线局域网的自组织网络



#### VLAN

虚拟局域网VLAN (Virtual Local Area Network)是一种将**局域网内的设备划分成与物理位置无关的逻辑组的技术**，这些逻辑组有某些共同的需求。每个VLAN是一个单独的广播域/不同的子网。

![QQ截图20220629162427](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291624135.jpg)

相同vlan组的设备才能进行广播通信，不同vlan为不同子网。

##### 产生背景

- **缺乏流量隔离**:即使把组流量局域化道一个单一交换机中，广播流量仍会跨越整个机构网络；以太网中出现大量的广播帧，特别是经常使用的ARP和DHCP协议。
- **管理用户不便**:如果一个主机在不同组间移动，必须改变物理布线，连接到新的交换机上。
- **对信息保密和安全不利**：以个单位的不同部门共享一个局域网。

##### vlan的实现

**方法一（常用）**

![QQ截图20220629162624](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291626776.jpg)

通过转发表和vlan表，为数据帧打上标签，转发时，如果帧的vlanID和端口的vlanID不匹配，则不转发。

**方法二**

![QQ截图20220629162842](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291628730.jpg)

在vlan表中写死MAC地址。

**方法三**

基于IP地址，根据网络层地址或协议划分VLAN，这样VLAN就可以跨越路由器进行扩展，将多个局域网的主机连接在一起

##### IEEE802.1Q帧

![QQ截图20220629162957](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206291631888.jpg)

VLAN标记的前两个字节表明是IEEE 802.1Q帧，接下来4位没用，==后面12位是VLAN标识符VID==,唯一表示了该以太网帧属于哪个VLAN。

- VID的取值范围为0-4095，但0和4095都不用来表示VLAN，因此用于表示VLAN的==有效VID取值范围为1-4094==。
- IEEE 802.1Q帧是由交换机来处理的，而不是由用户主机来处理的。（即==主机和交换机之间只交换普通的以太网帧==，**具体解释**：当交换机把帧给主机时，会将vlan标记去除；两个交换机交换帧时，必须是主干链路（trunk）才能传输vlan标记，否则也会先去除vlan标记）



### 广域网

广域网的通信子网主要使用==分组交换==技术。广域网的通信子网可以利用公用分组交换网、卫星通信网和无线分组交换网，它将分布在不同地区的**局域网或计算机系统**互连起来，达到==资源共享==的目的。如因特网（Internet)是世界范围内最大的广域网。

#### 结点交换机

广域网由一些**结点交换机**（==注意不是路由器==，结点交换机和路由器都用来==转发分组==，它们的工作原理也类似。结点交换机在==单个网络中==转发分组，而路由器在多个网络构成的互联网中转发分组）及连接这些交换机的链路组成。结点交换机的功能是将分组存储并转发。结点之间都是==点到点连接==，但为了提高网络的可靠性，通常一个结点交换机往往与多个结点交换机相连。

#### 特性

##### **不同于局域网**

1. 广域网覆盖的是物理层，链路层，网络层
2. 覆盖范围广
3. 点到点连接，但为了可靠性，一个结点交换机往往与多个结点交换机相连
4. 强调资源共享，而不是数据传输



#### PPP协议

![QQ截图20220630150834](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206301509328.jpg)

##### 特点

只支持**全双工**

**面向字节**： PPP帧的长度都是整数个字节，通过==转义字符实现透明传输==

点对点连接，不使用CSMA/CD，就==不需要最短帧==，信息段占0~1500 B；

##### 应满足的要求

**简单**﹐对于链路层的帧，无需纠错，无需序号，无需流量控制。

**封装成帧** 帧定界符

**透明传输** 与帧定界符一样比特组合的数据应该如何处理:异步线路用字节填充，同步线路用比特填充。

**多种网络层协议 **封装的IP数据报可以采用多种协议。
**多种类型链路**  串行/并行，同步/异步，电/光....差错检测错就丢弃。
**检测连接状态**  链路是否正常工作。最大传送单元数据部分最大长度MTU。
**网络层地址协商** 知道通信双方的网络层地址。

**数据压缩协商**

##### 无需满足的要求

**纠错** 只检错，检测到错误直接丢弃帧

**流量控制** 

**序号和确认机制**

**不支持多点线路**



##### PPP的三个组成部分

1. 一个将IP数据报封装到串行链路（同步串行/异步串行)的方法。信息部分受最大传送单元MTU限制

2. **链路控制协议LCP**:建立并维护数据链路连接。身份验证
3. **网络控制协议NCP**:PPP可支持多种网络层协议，每个不同的网络层协议都要一个相应的NCP来配置，为网络层协议建立和配置逻辑连接。

##### 协议状态图

![QQ截图20220630144052](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206301441191.jpg)

##### 帧格式

![QQ截图20220630144150](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206301441826.jpg)



### 数据链路层设备

#### 网桥

用途：隔离冲突域

##### 网桥的分类

###### 透明网桥

“透明”指以太网上的站点并不知道所发送的帧将经过哪几个网桥，是一种即插即用设备—-==自学习==。

###### 源路由网桥

源路由网桥:在发送帧时，把详细的最佳路由信息（==路由最少/时间最短==）放在帧的首部中。

方法:源站以广播方式向欲通信的目的站发送一个发现帧。可以寻找出多种路径，然后发现帧返回后，网桥记录最佳路由，以后发往该目的站时，在帧首部加入最佳路由信息。



#### 交换机

又称，以**太网交换机**，本质上是**多端口网桥**。

用来隔离**冲突域**，通过VLAN还能隔离**广播域**。

![QQ截图20220630155348](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202206301554571.jpg)

交换机对==工作站是透明==的。

##### 特点

1. 以太网交换机的特点:以太网交换机的每个端口都直接与单台主机相连（网桥的端口往往连接到一个网段)，并且一般都工作在全双工方式。
2. 以太网交换机能同时连通多对端口，使每对相互通信的主机都能像独占通信媒体那样，==无碰撞==地传输数据，也就是==隔离冲突域==。
3. 以太网交换机是一种即插即用设备，其内部的帧的转发表是通过==自学习算法==自动地逐渐建立起来的。
4. 以太网交换机由于使用专用的交换结构芯片，交换速率较高。
5. 以太网交换机==独占传输媒体的带宽==-每个端口结点占用的带宽不会因为端口结点数目的增加而减少，且整个交换机的总带宽会随着端口结点的增加而增加。

##### 两种交换模式

###### 直通式交换机

- 查完目的地址==（6B）==就立刻转发。
- **延迟小**，可靠性低，**无法支持具有不同速率的端口的交换**。

###### 存储转发式交换机

- 将帧放入高速缓存，并检查否正确，正确则转发，错误则丢弃。
- 延迟大，可靠性高，**可以支持具有不同速率的端口的交换**。

##### 自学习功能

​	当交换机收到一个帧（从A想发往B）时，如果源地址A不在交换表中，则交换器记录A的MAC地址，以及来自哪个端口；如果目的地址B，不在交换表中，则将帧转发到==除发送来的端口外所有端口==，如果在，则只往对应的端口发送。

##### ==端口带宽计算==



假设端口是10mb/s，如果交换机支持全双工，则带宽为20mb/s，半双工则带宽为10mb/s；

若支持半双工，有24个接口则，交换机总容量为120mb/s；全双工则240ms/s

### 冲突域（网段）和广播域

#### 冲突域

在同一个冲突域中的每一个节点都能收到所有被发送的帧。简单的说就是同一时间内只能有一台设备发送信息的范围。多台设备发送数据会发生碰撞。

一个**网段**就是一个冲突域

#### 广播域

网络中能接收任一设备发出的广播帧的所有设备的集合。简单的说如果站点发出一个广播信号，所有能接收收到这个信号的设备范围称为一个广播域。

#### 如何隔离冲突域和广播域

|                              | 能否隔离冲突域 | 能否隔离广播域       |
| ---------------------------- | -------------- | -------------------- |
| 物理层设备（中继器，集线器） | ×              | ×                    |
| 链路层设备（网桥，交换器）   | √              | 交换器可通过VLAN实现 |
| 网络层设备（路由器）         | √              | √                    |





## 网络层

### 网络层的功能

#### 异构网络互联



#### 路由与转发（控制平面和数据平面）

路由器主要有两个功能路由与分组转发，路由对应**控制平面**，分组转发对应**数据平面**



#### ==SDN==（Software-Defined Networking）

它采用==集中式的控制层面==和==分布式的数据层面==。

**传统网络**采用的是分布式的数据层面和控制层面。

##### 知识结构图

![QQ截图20220701144645](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021613239.jpg)



##### 控制平面（传统方法）

**路由选择算法运行在每台路由器中**，并且在每台路由器中都包含转发和路由选择两种功能。

**具体方法**

在一台路由器中的路由选择算法与其他路由器中的路由选择算法通信（通过交换路由选择报文),计算出路由表和转发表。



##### 控制平面（SDN方法）

控制平面从路由器物理上分离。路由器仅实现转发，**远程控制器**计算和分发转发表以供每台路由器所使用。远程控制器通过==软件实现，可编程==

**具体方法**

路由器通过交换包含转发表和其他路由选择信息的报文与远程控制器通信。因为计算转发并与路由器交互的控制器是用软件实现的，所以网络是“==软件定义的=="。



##### 控制平面中的路由选择处理器

###### **传统方法**

**路由选择处理器执行控制平面功能**。在传统的路由器中，它执行路由选择协议，维护路由选择表于关联链路状态信息，并为该路由器计算转发表。

###### SDN**方法**

在SDN路由器中，**路由选择处理器负责与远程控制器通信**，目的是接收远程控制器计算的转发表项。



##### SDN控制平面组成

###### ==**SDN控制器**==：

维护准确的网络状态信息,(远程链路、路由器和主机的状态)﹔为运行在控制平面中的网络控制应用程序提供这些信息(逻辑集中，在多台服务器上实现)。

###### **网络控制应用程序**：

根据SDN控制器提供的方法，这些应用程序通过这些方法能够监视、编程和控制下面的网络设备。

![QQ截图20220701144150](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021613589.jpg)



##### SDN控制器的三个层次

###### 北向接口

SDN控制器通过"北向接口“与网络控制应用程序交互。该API允许网络控制应用程序在状态管理层之间读写网络状态。

###### 网络范围状态管理层:

由SDN控制平面作出的==最终控制决定==,将要求控制器具有有关网络的主机、链路等最新状态信息。

###### 通信层:

SDN控制器与受控网络设备之间的通信(OpenFlow协议)，包含"==南向接口==”

![QQ截图20220701144608](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021613374.jpg)





### IP数据报的格式

### IP数据报分片



### ==IPv4地址==

IP地址:全世界唯一的32位/4字节标识符，标识路由器主机的==接口==（==一台主机或路由器可以有多个接口==）。

IP地址::={<网络号>,<主机号>}



#### 分类的IP地址

![QQ截图20220702135416](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021613040.jpg)

![QQ截图20220702140408](%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.assets/QQ%E6%88%AA%E5%9B%BE20220702140408.jpg)



#### 特殊IP地址

![QQ截图20220702135547](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612127.jpg)



#### 私有IP地址

![QQ截图20220702135748](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612599.jpg)



#### NAT

网络地址转换（NAT）是指通过将专用网络转换为共用地址，从而==对外隐藏内部管理的IP地址==。

**网络地址转换NAT**(Network Address Translation):在**专用网**连接到**因特网**的路由器上安装NAT软件，安装了NAT软件的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址。

![QQ截图20220702141445](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612568.jpg)

**例**：专用网内有一个主机IP为192.168.0.3 ，应用程序端口为30000，该应用程序向外网中的213.18.2.4的主机发送数据报，经过NAT路由器后，NAT路由器通过NAT转换表将数据报的**源IP地址**会被改写成173.38.1.5，端口为40001；当213.18.2.4返回数据报时，IP目的地址也是为173.38.1.5，端口40001，经过NAT路由器时，再改变为192.168.0.3

==note：==

NAT转换表中的表项需要管理员设置，主机发送的分组的端口和ip地址如果在NAT转换表中没有对应映射，则服务器不转发分组



#### 子网划分和子网掩码

##### 分类的IP地址的弱点

1. IP地址空间的利用率有时很低
2. 两级IP地址不够灵活

##### 子网划分

在主机号中划分出一块作为子网号

![QQ截图20220702144354](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021613552.jpg)

- 子网能否全0全1要看情况
- 某单位划分子网后，对==外仍表现为一个网络==，即外网不知道本单位内的子网的划分。

##### 子网掩码

![QQ截图20220702144550](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612543.jpg)

网络号和子网号部分的子网掩码都为1，主机号为0；

将**IP地址和子网掩码**==相与==，可得到该IP地址的子网号（实际上是网络号加子网号）



#### ==无分类编址CIDR==

##### 概念

**无分类域间路由选择CIDR**：

1. 消除了传统的A类,B类和c类地址以及划分子网的概念。

   ![QQ截图20220702150852](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612424.jpg)

   不再使用网络号和子网号，而是改为**网络前缀**

   CIDR记法:IP地址后加上“/”，然后写上网络前缀(可以任意长度)的位数。 e.g. 128.14.32.0/20

2. 融合子网地址与子网掩码，方便子网划分。

   CIDR把网络前缴都相同的连续的IP地址组成“**CIDR地址块**”。

   ![QQ截图20220702151034](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207021612423.jpg)

   3. 是可以在软件的支持下实现**超网构造**的一种IP地址的划分方法

   

##### 构成超网（路由聚合）

将多个子网聚合成一个较大的子网，叫做**构成超网**，或**路由聚合**。

方法:将网络前缀缩短（==所有网络地址取交集==）。假如一个路由器转发表中多个相似的网络都对应同一个接口，则将这几个网络的网络前缀中相同的部分取出来，缩短网络前缀将多个转发数据项合为一条。

##### 最长前缀匹配

使用CIDR时，查找路由表可能得到几个匹配结果（跟网络掩码按位相与)，应选择具有最长网络前缀的路由。==前缀越长，地址块越小，路由越具体==。



#### ==网络层分组转发过程==

##### 路由表中：

1. 目的网络地址
2. 目的网络子网掩码
3. 下一跳地址

##### **主机路由**：

主机路由:对特定目的主机的P地址专门指明一个路由，以方便网络管理员控制和测试网络。若特定主机的P地址是a.b.c.d，则转发表中对应项的目的网络是 ==a.b.c.d/32==。132表示的子网掩码没有意义，但这个特殊的前缀可以用在转发表中。

##### **默认路由**:

用特殊前缀0.0.0.0/0表示默认路由，全0掩码和任何目的地址进行按位与运算，结果必然为全0,即必然和转发表中的0.0.0.0/O相匹配。只要目的网络是其他网络(不在转发表中)，就一律选择默认路由。

##### 路由器转发分组的算法：

1. 提取目的IP地址
2. 是否直接交付
3. 特定主机路由：若查找到特定主机路由（目的地址4)，就按照这条路由的下一跳转发分组;否则进入下一步骤
4. 从转发表中的下一条（即==按前缀长度的顺序，前缀长度长的先匹配（书中直说按前缀长度，个人理解应当先检查前缀长的）==）开始检查。若网络前缀匹配，则转发分组，否则，若有下一行，进入下一行，重复该步骤。
5. 默认路由：没有匹配的下一跳时，若路由器内有默认路由，则使用默认路由；否则，转发分组出错。
6. 分组TTL耗尽还没到目的主机，则丢弃，报告转发分组出错

==note：==

得到下一跳路由器的P地址后，并不是直接将该地址填入待发送的数据报，而是将该地址转换成MAC 地址（通过ARP)，将此MAC地址放到MAC帧首部中，然后根据这个MAC地址找到下一跳路由器。==在不同网络中传送时，MAC帧中的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址==，请注意区分。

#### ARP协议

**问题背景**：在实际网络的链路上传送数据帧时，最终必须使用MAC地址。

**ARP协议**:完成主机或路由器IP地址到MAC地址的映射。解决下一跳走哪的问题。

##### ARP协议使用过程

==检查ARP高速缓存==，有对应表项则写入MAC帧，没有则用目的MAC地址为FF-FF-FF-FF-FF-FF的帧封装并==广播ARP请求分组==，同一局域网中所有主机都能收到该请求。目的主机收到请求后就会==向源主机单播一个ARP响应分组==，源主机收到后将此映射写入ARP缓存（10-20min更新一次)。

##### ARP协议4中典型情况

1. 主机A发给本网络上的主机B:用ARP找到主机B的硬件地址;
2. 主机A发给另一网络上的主机B:用ARP找到本网络上一个路由器（网关）的硬件地址;
3. 路由器发给本网络的主机A:用ARP找到主机A的硬件地址;
4. 路由器发给另一网络的主机B:用ARP找到本网络上的一个路由器的硬件地址。

#### DHCP协议

##### 主机如何获得IP地址

###### 静态配置

###### 动态配置（使用DHCP）



##### 概述

动态主机配置协议DHCP是==应用层==协议，使用==客户/服务器==方式，客户端和服务端通过==广播方式==进行交互，==基于UDP==。

DHCP提供**即插即用**联网的机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址,允许**地址重用**，支持**移动用户加入网络**，支持**在用地址续租**。

DHCP==允许网络上配置多台DHCP服务器==，当DHCP客户机发出“DHCP 发现”消息时，有可能收到多个应答消息。这时，DHCP客户机只会挑选其中的一个，通常挑选最先到达的。
DHCP服务器分配给DHCP客户的IP地址是==临时的==，因此 DHCP客户只能在一段有限的时间内有效。这段时间称作**租用期**。

##### 流程

1. 主机**广播**DHCP发现报文（试图找到网络中的服务器）

2. DHCP服务器**广播**DHCP提供报文（服务器拟分配给主机一个IP地址及相关配置，先到先得）

3. 主机**广播**DHCP请求报文（主机箱服务器请求提供IP地址，同时告诉别的DHCP服务器，主机不需要他们的IP地址了）

4. DHCP服务器**广播**DHCP确认报文（正式将IP地址分配给主机）

**note**：广播时，主机广播的报文，源地址为0.0.0.0 ，目的地址为255.255.255.255；DHCP服务器广播的报文，源地址为DHCP服务器地址，目的地址为255.255.255.255



#### ICMP协议

##### 概述

为了提高IP数据报交付成功的机会，在网络层使用了网际控制报文协议（Internet Control Message Protocol，ICMP）来让主机或路由器报告差错和异常情况。ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。ICMP是==IP层协议==。

**作用**：

1. 差错或异常报告
2. 网络探询

**种类：**

1. 差错报文
2. 探询报文

##### ICMP报文格式



![QQ截图20220703144126](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207031444962.jpg)

检验和不检验数据部分，所以ICMP不实现**差错控制**

##### ICMP差错报文

###### 差错报文类型

1. **终点不可达**。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。==（无法交付）==
2. **源点抑制**。当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。（==拥塞丢数据==）
3. **时间超过**。当路由器收到生存时间(TTL)为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。（==TTL=0==）
4. **参数问题**。当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。（==首部字段有问题==）
5. **改变路由（重定向)**。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（==可通过更好的路由==)。

###### 差错报文数据字段

![QQ截图20220703145110](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207031451941.jpg)

###### 不应发送ICMP差错报文的情况

1. 对**ICMP差错报告报文**不再发送ICMP差错报告报文。

2. 对第一个分片的数据报片的所有**后续数据报片**都不发送ICMP差错报告报文。

3. 对具有**组播地址**的数据报都不发送ICMP差错报告报文。

4. 对具有**特殊地址**（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文。

##### ICMP询问报文

1. **回送请求和回答报文**

   主机或路由器向特定目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。==测试目的站是否可达以及了解其相关状态==。

2. **时间戳请求和回答报文** 

   请某个主机或路由器回答当前的日期和时间。==用来进行时钟同步和测量时间==。

3. 地址掩码请求和回答报文

4. 路由器询问和通告报文

**后两者不常用**

##### ICMP应用

###### PING

测试两个主机之间的连通性，使用了ICMP回送请求和回答报文。

###### Traceroute

跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文。



### IPv6

#### IPv6数据报格式

![QQ截图20220704145916](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207041459559.jpg)

**版本**：指明了协议版本，总是6。

**优先级**：区分数据报的类别和优先级。

**流标签**：“流”是互联网络上从特定源点到特定终点的一系列数据报。所有属于同一个流的数据报都具有同样的流标签。

**下一个首部**：标识下一个扩展首部或上层协议首部。

**跳数限制**：相当于IPv4的TTL

#### IPv6和IPv4的区别

1. IPv6将地址从32位（4B）扩大到==128位(16B)==，更大的地址空间。
2. IPv6将IPv4的**校验和字段彻底移除**，以减少每跳的处理时间。

3. IPv6将IlPv4的可选字段移出首部，变成了==扩展首部==，成为灵活的首部格式，路由器通常不对扩展首部进行检查，大大提高了路由器的处理效率。

4. IPv6支持==即插即用==（即自动配置），不需要DHCP协议。
5. IPv6首部长度必须是==8B的整数倍==,IPv4首部是4B的整数倍。
6. IPv6==只能在主机处分片==,IPv4可以在路由器和主机处分片。
7. ICMPv6:附加报文类型“分组过大”。

8. IPv6支持资源的预分配，支持实时视像等要求，保证一定的带宽和时延的应用。
9. IPv6取消了协议字段，改成下一个首部字段。
10. IPv6取消了总长度字段，改用有效载荷长度字段。
11. IPv6取消了服务类型字段。

#### IPv6地址表示形式

##### 一般形式

冒号十六进制记法：4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170

##### 压缩形式

###### **普通压缩**

4BF5:0000:0000:0000:BA 5F:039A:000A 2176

压缩成：

4BF5:0:0:0:BA5F:39A:A:2176

###### 零压缩

一连串连续的0可以被一对冒号取代。

FF05:0:0:0:0:0:0:B3

FF05::B3

==双冒号表示法在一个地址中仅能出现一次==。



#### IPv6基本地址类型

##### 单播

一对一通信

可做源地址+目的地址



##### 多播

一对多通信

可做目的地址

##### 任播

一对多中的一个通信

（这是IPv6增加的一种类型。任播的目的站是一组计算机，但数据报在交付时==只交付其中的一台计算机，通常是距离最近的一台计算机==。）

可做目的地址



#### IPv4向IPv6过滤的策略

##### 双栈协议

双协议栈技术就是指在一台设备上==同时启用IPv4协议栈和IPv6协议栈==。这样的话，这台设备既能和IPv4网络通信，又能和IPv6网络通信。如果这台设备是一个**路由器**，那么这台路由器的不同接口上，分别配置了IPv4地址和IPv6地址，并很可能分别连接了IPv4网络和IPv6网络。如果这台设备是一个**计算机**，那么它将同时拥有IPv4地址和IPv6地址，并具备同时处理这两个协议地址的功能。

##### 隧道技术

通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据（或负载)可以是不同协议的数据帧或包。隧道协议将其它协议的数据帧或包==重新封装==然后通过隧道发送。



### 路由协议

#### 自治系统（AS）

**自治系统**(Autonomous System，AS):单--技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同的度量来确定分组在该AS内的路由，同时还使用一种AS之间的路由选择协议来确定分组在AS之间的路由。

一个自治系统内的所有网络都由一个行政单位（如一家公司、一所大学、一个政府部门等)管辖，一个自治系统的所有路由器在本自治系统内都必须是连通的。

#### 路由协议分类

##### 内部网关协议（IGP）

如RIP，OSPF

##### 外部网关协议（EGP）

如BGP

#### 路由信息协议RIP

RIP是一种分布式的基于距离向量的路由选择协议，是因特网的协议标准，最大优点是**简单**。

##### RIP规定

1. RIP协议要求网络中每一个路由器都维护从它自己到其他每一个目的网络的**唯一**最佳距离记录（即一组距离，称为**距离向量**)。

2. **距离:**通常为“跳数”，即从源端口到目的端口所经过的路由器个数，经过一个路由器跳数+1。特别的，从一路由器到直接连接的网络距离为1。
3. ==优先选择跳数少的路径==（而不是时间短的）
4. RIP允许一条路由最多只能包含15个路由器，因此距离为==16表示网络不可达==。所以RIP只适用于小型网络。
5. RIP中每个网络的子网掩码必须相同。

##### ==RIP特点==(与OSPF比较)

<a id="RIP_tedian">RIP特点</a>

1. 仅和**相邻路由器**交换信息。

2. 路由器交换的信息是**自己的路由表**。

3. ==每30秒==交换一次路由信息，然后路由器根据新信息更新路由表。若超过180s没收到邻居路由器的通告，则判定邻居没了，并更新自己路由表。
4. RIP是==应用层==协议，使用==UDP==传输数据（端口520）。

路由器刚开始工作时，只知道直接连接的网络的距离（距离为1)，接着每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

经过若干次更新后，所有路由器最终都会知道到达本自治系统任何一个网络的最短距离和下一跳路由器的地址，即“收敛”。



##### ==距离向量算法==

1. 修改相邻路由器发来的RIP报文中**所有表项**

   对地址为x的相邻路由器发来的RIP报文，修改此报文中的所有项目:==把“下一跳”字段中的地址改为x==，并把==所有的“距离”字段+1==。

2. 对修改后的RIP报文中的每一个项目，进行以下步骤;

   1. R1路由表中若没有Net3，则把该项目填入R1路由表
   2. R1路由表中若有Net3，则查看下一跳路由器地址:
      - 若下一跳是x，则用收到的项目替换源路由表中的项目;
      - 若下一跳不是x，原来距离比从X走的距离远则更新，否则不作处理。
   3. 若180s还没收到相邻路由器x的更新路由表，则把x记为不可达的路由器，即把距离设置为16。
   4. 返回

##### 优缺点

###### 优点

实现简单、开销小、收敛过程较快。

###### 缺点

1. RIP限制了网络的规模，它能使用的==最大距离为15==（16表示不可达)。

2. 路由器之间交换的是路由器中的完整路由表，因此网络规模越大，开销也越大。
3. 3）网络出现故障时，会出现==慢收敛现象==（即需要较长时间才能将此信息传送到所有路由器)，俗称“==坏消息传得慢==”，使更新过程的收敛时间长。



#### 开放最短路径优先（OSPF）协议

OSPF最主要的特征就是使用分布式的**链路状态协议**。

##### 特点

与RIP特点对比--[跳转到 RIP特点](#RIP_tedian)  

1. 使用洪泛法向自治系统内**所有路由器**发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器。

   最终整个区域内所有路由器都得到了这个信息的一个副本。

2. 发送的信息就是与本路由器**相邻的所有路由器的链路状态**（本路由器和哪些路由器相邻，以及该链路的度量/代价――费用、距离、时延、带宽等）。

3. 只有当**链路状态发生变化**时，路由器才向所有路由器洪泛发送此信息。

4. OSPF是==网络层协议==，不使用UDP或TCP，而直接用IP数据报传送。而RIP是应用层协议，在传输层使用UDP。

最后，所有路由器都能建立一个**链路状态数据库**，即**全网拓扑图**。

**其它特点**

1. 每隔30min，要刷新一次数据库中的链路状态。

2. 由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模开无宜按天系。因此当互联网规模很大时，OSPF协议要比距离向量协议RIP好得多。

3. OSPF不存在坏消息传的慢的问题，它的收敛速度很快。

##### 链路状态路由算法（分组类型）

1. 每个路由器发现它的邻居结点【HELLO问候分组】，并了解邻居节点的网络地址。**通常每个10秒，每两个相邻路由器要交换一次问候分组**。

2. 设置到它的每个邻居的==成本度量metric==。

3. 构造【DD数据库描述分组】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息

4. 如果DD分组中的摘要自己都有，则邻站不做处理;如果有没有的或者是更新的，则发送【LSR链路状态请求分组】请求自己没有的和比自己更新的信息。

5. 收到邻站的LSR分组后，发送【LSU链路状态更新分组】进行更新。

6. 更新完毕后，邻站返回一个【LSAck链路状态确认分组】进行确认。

   只要一个路由器的链路状态发生变化:

   5. 泛洪发送【LSU链路状态更新分组】进行更新。
   6. 更新完毕后，其他站返回一个【LSAck链路状态确认分组】进行确认。7.使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径。

##### OSPF的区域

为了使OSPF能够用于规模很大的网络，OSPF将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个32位的区域标识符（用点分十进制表示）。

区域也不能太大，在一个区域内的路由器最好不超过200个。

![QQ截图20220704165928](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207041659059.jpg)



#### 边界网关协议（BGP）

边界网关协议（BGP）只能力求寻找一条能够到达目的网络且==比较好的路由==（不能兜圈子),而==并非寻找一条最佳路由==。BGP采用的是==路径向量路由选择==协议，它与距离向量协议和链路状态协议有很大的区别。

##### 工作原理

BGP的.工作原理如下:每个自治系统的管理员要选择至少出个路由器约以有多个）作为该自治系统的==“BGP发言人"==。一个BGP发言人与其他自治系统中的BGP发言人要交换路由信息,就要先==建立TCP连接==（可见BGP 报文是通过TCP传送的，也就是说BGP报文是TCP报文的数据部分)，然后在此连接上交换BGP报文以建立BGP会话，再利用BGP 会话交换路由信息。当所有BGP发言人都相互交换网络可达性的信息后，各BGP发言人就可找出到达各个自治系统的较好路由。

==每个BGP发言人除必须运行BGP外，还必须运行该AS所用的内部网关协议==，如OSPF或RIP。BGP所交换的网络可达性信息就是要到达某个网络（用网络前缀表示）所要经过的一系列AS。图4.12给出了一个BGP发言人交换路径向量的例子。

![QQ截图20220705143600](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207051436627.jpg)

##### 特点

1) BGP交换路由信息的结点数量级是自治系统的数量级，要比这些自治系统中的网络数少很多
2) 每个自治系统中BGP发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。
3) ==BGP支持CIDR==，因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
4) 在 BGP刚运行时，BGP的邻站交换整个BGP路由表，但==以后只需在发生变化时更新有变化的部分==。这样做对节省网络带宽和减少路由器的处理开销都有好处。
5) BGP是==应用层==协议，它是基于==TCP==的。

##### BGP-4的四种报文

1. **OPEN(打开)报文**:用来与相邻的另一个BGP发言人建立关系，并认证发送方。
2. **UPDATE（更新）报文**:通告新路径或撤销原路径。

3. **KEEPALIVE（保活）报文**:在无UPDATE时，周期性证实邻站的连通性;也作为OPEN的确认。
4. **NOTIFICATION (通知）报文**:报告先前报文的差错;也被用于关闭连接。

#### ==三种路由协议的比较==

![QQ截图20220705144349](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207051443972.jpg)



### 组播（多播）

#### IP数据报三种传输方式

##### 单播

##### 广播

##### 组播（多播）

![QQ截图20220705153617](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207051536526.jpg)

#### IP组播地址

IP组播地址让源设备能够将分组发送给一组设备。属于多播组的设备将被分配一个**组播组IP地址**（**一群共同需求主机的相同标识**）。

组播地址范围为224.0.0.0~239.255.255.255(D类地址)，一个D类地址表示一个组播组。==只能用作分组的目标地址==。源地址总是为单播地址。



#### 特点

1. 组播数据报也是“尽最大努力交付”，==不提供可靠交付==，只应用于==UDP==。

2. 对组播数据报不产生ICMP差错报文。

3. 并非所有D类地址都可以作为组播地址。

#### 硬件组播

在因特网上进行组播的最后阶段，还是要把组播数据报在局域网上用硬件组播交付给组播组的所有成员。

组播MAC地址以十六进制值==01-00-5E==打头，余下的6个十六进制位是根据IP组播组地址的最后23位转换得到的。

TCP/IP协议使用的以太网多播地址的范围是:
从01-00-5E-00-00-00到01-00-5E-7F-FF-FF .

![QQ截图20220705153914](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207051539646.jpg)

因为IP组播地址中有5位不参与硬件组播地址的映射，所以==有可能导致不同的ip组播地址映射出相同的硬件组播地址==。

所以收到多播数据报的主机，还要在IP层利用软件进行过滤，把不是本主机要接收的数据报丢弃。



#### IGMP（因特网组管理协议）

IGMP协议让路由器知道本局域网上**是否有主机(的进程)参加或退出**了某个组播组。

IGMP使用==IP数据报==。

##### 两个工作阶段

###### 阶段1

- 某主机要加入组播组时，该主机向组播组的组播地址发送一个lGMP报文，声明自己要称为该组的成员。

- 本地组播路由器收到IGMP报文后，要利用组播路由选择协议把这组成员关系发给因特网上的其他组播路由器。

###### 阶段2

- 本地组播路由器周期性探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员。

- 只要有一个主机对某个组响应，那么组播路由器就认为这个组是活跃的;如果经过几次探询后没有一个主机响应，组播路由器就认为本网络上的没有此组播组的主机，因此就不再把这组的成员关系发给其他的组播路由器。

==组播路由器知道的成员关系只是所连接的局域网中有无组播组的成员==。



#### 组播路由算法

组播路由选择协议目的是找出**以源主机为根节点**的**组播转发树**。

构造树可以避免在路由器之间兜圈子。

对不同的多播组对应于不同的多播转发树;同一个多播组，对不同的源点也会有不同的多播转发树。

![QQ截图20220705154803](https://cdn.jsdelivr.net/gh/chaoran4532/typora-upload-images@main/images/202207051548441.jpg)

组播路由
